#!/bin/bash
# Modify ~/.claude/settings.json
# Syncs: statusLine, language, permissions.deny, enabledPlugins, model
# Preserves: feedbackSurveyState, and any other local-only fields

set -e

# Read existing content from stdin
existing=$(cat)

# Define the fields we want to sync
synced_fields='{
  "$schema": "https://json.schemastore.org/claude-code-settings.json",
  "model": "opus",
  "statusLine": {
    "type": "command",
    "command": "input=$(cat); branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo '\''no-git'\''); echo \"ðŸŒ¿ $branch | $(echo \"$input\" | jq -r '\''.model.display_name'\'') | $(basename \"$(echo \"$input\" | jq -r '\''.workspace.current_dir'\'')\")\""
  },
  "enabledPlugins": {
    "code-review@claude-plugins-official": true,
    "superpowers@claude-plugins-official": true
  },
  "language": "Traditional Chinese (zh-TW)",
  "permissions": {
    "deny": [
      "Read(.env*)",
      "Read(**/secrets/**)",
      "Write(.env*)",
      "Bash(rm -rf /)"
    ]
  }
}'

# If file doesn't exist or is empty, use synced fields as defaults
if [ -z "$existing" ]; then
    echo "$synced_fields"
    exit 0
fi

# Merge: existing fields + synced fields (synced fields win on conflict)
echo "$existing" | jq --argjson sync "$synced_fields" '
  . * $sync
'
