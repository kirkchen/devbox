#!/bin/bash
set -e

echo "ðŸ› ï¸ Installing CLI tools..."

{{- if eq .chezmoi.os "darwin" }}
# macOS: Install using Homebrew
if command -v brew &> /dev/null; then
    echo "ðŸ“¦ Installing tools via Homebrew..."
    
    # Core tools
    brew list fzf &>/dev/null || brew install fzf
    brew list eza &>/dev/null || brew install eza  # Modern ls replacement
    brew list bat &>/dev/null || brew install bat
    brew list the_silver_searcher &>/dev/null || brew install the_silver_searcher
    brew list tig &>/dev/null || brew install tig
    brew list diff-so-fancy &>/dev/null || brew install diff-so-fancy
    brew list htop &>/dev/null || brew install htop
    brew list direnv &>/dev/null || brew install direnv
    
    # Set up fzf key bindings and fuzzy completion
    if [ -d "$(brew --prefix)/opt/fzf" ]; then
        $(brew --prefix)/opt/fzf/install --key-bindings --completion --no-update-rc --no-bash --no-fish 2>/dev/null || true
    fi
else
    echo "âš ï¸ Homebrew not found. Please install Homebrew first."
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux: Install using apt or other package managers
if command -v apt-get &> /dev/null; then
    echo "ðŸ“¦ Installing tools via apt..."
    
    # Update package list
    sudo apt-get update
    
    # Install core tools
    # fzf
    if ! command -v fzf &> /dev/null; then
        sudo apt-get install -y fzf || {
            echo "Installing fzf from git..."
            git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
            ~/.fzf/install --all --no-bash --no-fish
        }
    fi
    
    # eza (modern ls replacement)
    if ! command -v eza &> /dev/null; then
        echo "Installing eza..."
        # Install eza from official repo
        sudo apt-get install -y gpg
        wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
        echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
        sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
        sudo apt-get update
        sudo apt-get install -y eza || echo "Failed to install eza"
    fi
    
    # bat (better cat)
    if ! command -v bat &> /dev/null; then
        sudo apt-get install -y bat || echo "bat not available in apt"
        # On some systems, bat is installed as batcat
        if command -v batcat &> /dev/null; then
            mkdir -p ~/.local/bin
            ln -sf $(which batcat) ~/.local/bin/bat
        fi
    fi
    
    # ag (silver searcher)
    sudo apt-get install -y silversearcher-ag
    
    # tig (git text interface)
    sudo apt-get install -y tig
    
    # htop
    sudo apt-get install -y htop
    
    # direnv
    if ! command -v direnv &> /dev/null; then
        sudo apt-get install -y direnv || {
            echo "Installing direnv from binary..."
            curl -sfL https://direnv.net/install.sh | bash
        }
    fi
    
    # diff-so-fancy
    if ! command -v diff-so-fancy &> /dev/null; then
        echo "Installing diff-so-fancy..."
        npm install -g diff-so-fancy 2>/dev/null || {
            # Alternative: Download directly
            sudo curl -L https://raw.githubusercontent.com/so-fancy/diff-so-fancy/master/third_party/build_fatpack/diff-so-fancy -o /usr/local/bin/diff-so-fancy
            sudo chmod +x /usr/local/bin/diff-so-fancy
        }
    fi
fi

{{- end }}

echo "âœ… CLI tools installation complete!"