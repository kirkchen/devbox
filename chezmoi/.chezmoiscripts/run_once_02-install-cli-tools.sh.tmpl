#!/bin/bash
set -e

echo "üõ†Ô∏è Installing CLI tools..."

# Helper function to check if command exists
command_exists() {
    command -v "$1" &> /dev/null
}

{{- if eq .chezmoi.os "darwin" }}
# macOS: Install using Homebrew
if command_exists brew; then
    echo "üì¶ Installing tools via Homebrew..."
    
    # Check and install each tool individually
    command_exists fzf || brew install fzf
    command_exists eza || brew install eza
    command_exists bat || brew install bat
    command_exists ag || brew install the_silver_searcher
    command_exists tig || brew install tig
    command_exists htop || brew install htop
    command_exists direnv || brew install direnv
    
    # diff-so-fancy via npm (for consistency across platforms)
    if ! command_exists diff-so-fancy; then
        echo "Installing diff-so-fancy..."
        if command_exists npm; then
            npm install -g diff-so-fancy
        else
            echo "‚ö†Ô∏è npm not found. Skipping diff-so-fancy installation."
        fi
    fi
    
    # Set up fzf key bindings if fzf was installed via brew
    if [ -d "$(brew --prefix)/opt/fzf" ] && [ ! -f "$HOME/.fzf.zsh" ]; then
        echo "Setting up fzf key bindings..."
        $(brew --prefix)/opt/fzf/install --key-bindings --completion --no-update-rc --no-bash --no-fish 2>/dev/null || true
    fi
else
    echo "‚ö†Ô∏è Homebrew not found. Please install Homebrew first."
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux: Install using apt or other methods
if command_exists apt-get; then
    echo "üì¶ Installing tools via apt and other sources..."
    
    # fzf
    if ! command_exists fzf; then
        if apt-cache show fzf &>/dev/null; then
            sudo apt-get update && sudo apt-get install -y fzf
        else
            echo "Installing fzf from git..."
            git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
            ~/.fzf/install --all --no-bash --no-fish
        fi
    fi
    
    # eza (if not already installed)
    if ! command_exists eza; then
        echo "Installing eza..."
        sudo apt-get update && sudo apt-get install -y gpg
        sudo mkdir -p /etc/apt/keyrings
        wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
        echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
        sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
        sudo apt-get update
        sudo apt-get install -y eza || echo "Failed to install eza"
    fi
    
    # bat
    if ! command_exists bat && ! command_exists batcat; then
        sudo apt-get update && sudo apt-get install -y bat
        # On some systems, bat is installed as batcat
        if command_exists batcat && ! command_exists bat; then
            mkdir -p ~/.local/bin
            ln -sf $(which batcat) ~/.local/bin/bat
        fi
    fi
    
    # Basic tools via apt (only install if not present)
    sudo apt-get update
    command_exists ag || sudo apt-get install -y silversearcher-ag
    command_exists tig || sudo apt-get install -y tig
    command_exists htop || sudo apt-get install -y htop
    command_exists direnv || sudo apt-get install -y direnv
    
    # diff-so-fancy (if not already installed)
    if ! command_exists diff-so-fancy; then
        echo "Installing diff-so-fancy..."
        if command_exists npm; then
            npm install -g diff-so-fancy
        else
            echo "‚ö†Ô∏è npm not found. Skipping diff-so-fancy installation."
        fi
    fi
fi

{{- end }}

echo "‚úÖ CLI tools installation complete!"

# Summary of installed tools
echo ""
echo "üìã Tool status:"
for tool in fzf eza bat ag tig diff-so-fancy htop direnv; do
    if command_exists "$tool" || ([ "$tool" = "bat" ] && command_exists batcat); then
        echo "  ‚úÖ $tool"
    else
        echo "  ‚ùå $tool (not found)"
    fi
done