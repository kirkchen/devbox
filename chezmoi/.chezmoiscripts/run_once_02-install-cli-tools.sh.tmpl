#!/bin/bash
set -e

echo "ğŸ› ï¸ Installing CLI tools..."

# Helper function to check if command exists
command_exists() {
    command -v "$1" &> /dev/null || [[ -x "$HOME/.local/bin/$1" ]]
}

{{- if eq .chezmoi.os "darwin" }}
# macOS: Install using Homebrew
if command_exists brew; then
    echo "ğŸ“¦ Installing tools via Homebrew..."
    
    # Check and install each tool individually
    command_exists fzf || brew install fzf
    command_exists eza || brew install eza
    command_exists bat || brew install bat
    command_exists ag || brew install the_silver_searcher
    command_exists tig || brew install tig
    command_exists htop || brew install htop
    command_exists direnv || brew install direnv
    command_exists zellij || brew install zellij
    command_exists lazygit || brew install lazygit
    command_exists delta || brew install git-delta
    command_exists alacritty || brew install --cask alacritty

    # Claude Code CLI (native installer)
    if ! command_exists claude; then
        echo "Installing Claude Code CLI..."
        curl -fsSL https://claude.ai/install.sh | bash
    fi

    # Set up fzf key bindings if fzf was installed via brew
    if [ -d "$(brew --prefix)/opt/fzf" ] && [ ! -f "$HOME/.fzf.zsh" ]; then
        echo "Setting up fzf key bindings..."
        $(brew --prefix)/opt/fzf/install --key-bindings --completion --no-update-rc --no-bash --no-fish 2>/dev/null || true
    fi
else
    echo "âš ï¸ Homebrew not found. Please install Homebrew first."
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux: Install using apt or other methods
if command_exists apt-get; then
    echo "ğŸ“¦ Installing tools via apt and other sources..."
    
    # fzf
    if ! command_exists fzf; then
        if apt-cache show fzf &>/dev/null; then
            sudo apt-get update && sudo apt-get install -y fzf
        else
            echo "Installing fzf from git..."
            git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
            ~/.fzf/install --all --no-bash --no-fish
        fi
    fi
    
    # eza (if not already installed)
    if ! command_exists eza; then
        echo "Installing eza..."
        sudo apt-get update && sudo apt-get install -y gpg
        sudo mkdir -p /etc/apt/keyrings
        wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
        echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
        sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
        sudo apt-get update
        sudo apt-get install -y eza || echo "Failed to install eza"
    fi
    
    # bat
    if ! command_exists bat && ! command_exists batcat; then
        sudo apt-get update && sudo apt-get install -y bat
        # On some systems, bat is installed as batcat
        if command_exists batcat && ! command_exists bat; then
            mkdir -p ~/.local/bin
            ln -sf $(which batcat) ~/.local/bin/bat
        fi
    fi
    
    # Basic tools via apt (only install if not present)
    sudo apt-get update
    command_exists ag || sudo apt-get install -y silversearcher-ag
    command_exists tig || sudo apt-get install -y tig
    command_exists htop || sudo apt-get install -y htop
    command_exists direnv || sudo apt-get install -y direnv

    # zellij (terminal multiplexer)
    if ! command_exists zellij; then
        echo "Installing zellij..."
        ARCH=$(dpkg --print-architecture)
        ZELLIJ_VERSION="0.41.2"
        if [ "$ARCH" = "amd64" ]; then ZELLIJ_ARCH="x86_64"; elif [ "$ARCH" = "arm64" ]; then ZELLIJ_ARCH="aarch64"; fi
        curl -L "https://github.com/zellij-org/zellij/releases/download/v${ZELLIJ_VERSION}/zellij-${ZELLIJ_ARCH}-unknown-linux-musl.tar.gz" -o /tmp/zellij.tar.gz
        sudo tar xzf /tmp/zellij.tar.gz -C /usr/local/bin
        sudo chmod +x /usr/local/bin/zellij
        rm /tmp/zellij.tar.gz
    fi

    # lazygit (git TUI)
    if ! command_exists lazygit; then
        echo "Installing lazygit..."
        ARCH=$(dpkg --print-architecture)
        LAZYGIT_VERSION="0.44.1"
        if [ "$ARCH" = "amd64" ]; then LG_ARCH="x86_64"; elif [ "$ARCH" = "arm64" ]; then LG_ARCH="arm64"; fi
        curl -L "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_${LG_ARCH}.tar.gz" -o /tmp/lazygit.tar.gz
        sudo tar xzf /tmp/lazygit.tar.gz -C /usr/local/bin lazygit
        sudo chmod +x /usr/local/bin/lazygit
        rm /tmp/lazygit.tar.gz
    fi

    # delta (modern diff viewer)
    if ! command_exists delta; then
        echo "Installing delta..."
        ARCH=$(dpkg --print-architecture)
        DELTA_VERSION="0.18.2"
        curl -L "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/git-delta_${DELTA_VERSION}_${ARCH}.deb" -o /tmp/delta.deb
        sudo dpkg -i /tmp/delta.deb
        rm /tmp/delta.deb
    fi

    # Claude Code CLI (native installer)
    if ! command_exists claude; then
        echo "Installing Claude Code CLI..."
        curl -fsSL https://claude.ai/install.sh | bash
    fi
fi

{{- end }}

# Zellij plugins
if command_exists zellij; then
    mkdir -p "$HOME/.config/zellij/plugins"
    if [[ ! -f "$HOME/.config/zellij/plugins/zellij-switch.wasm" ]]; then
        echo "Installing zellij-switch plugin..."
        curl -L -o "$HOME/.config/zellij/plugins/zellij-switch.wasm" \
            "https://github.com/mostafaqanbaryan/zellij-switch/releases/download/0.2.1/zellij-switch.wasm" 2>/dev/null || true
    fi
fi

echo "âœ… CLI tools installation complete!"

# Summary of installed tools
echo ""
echo "ğŸ“‹ Tool status:"
for tool in fzf eza bat ag tig zellij lazygit delta claude htop direnv; do
    if command_exists "$tool" || ([ "$tool" = "bat" ] && command_exists batcat); then
        echo "  âœ… $tool"
    else
        echo "  âŒ $tool (not found)"
    fi
done